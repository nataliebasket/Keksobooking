(()=>{"use strict";const e=(e,t,r,o)=>{const n=(e=Math.abs(e)%100)%10;return e>10&&e<20?o:n>1&&n<5?r:1===n?t:o},t=e=>{const t=document.createElement("div");t.style.zIndex=100,t.style.position="absolute",t.style.width="300px",t.style.right="50%",t.style.transform="translateX(50%)",t.style.top="55px",t.style.padding="10px 3px",t.style.fontSize="12px",t.style.textAlign="center",t.style.backgroundColor="#ffaa99",t.textContent=e,document.body.append(t),setTimeout((()=>{t.remove()}),2e3)},r="Не удалось получить данные с сервера :(",o=["gif","jpg","jpeg","png"],n=1e5,a="palace",c="flat",l="house",s="bungalow",i="hotel",u={[a]:"Дворец",[c]:"Квартира",[l]:"Дом",[s]:"Бунгало",[i]:"Отель"},d={[a]:1e4,[c]:1e3,[l]:5e3,[s]:0,[i]:3e3},p={lat:35.675178,lng:139.748876},m={ANY:{minprice:0,maxprice:1e5},MIDDLE:{minprice:10001,maxprice:5e4},LOW:{minprice:0,maxprice:1e4},HIGH:{minprice:50001,maxprice:1e5}},y={1:["1"],2:["2","1"],3:["3","2","1"],100:["0"]},f=document.querySelector("#card").content.querySelector(".popup"),v=(e,t)=>{e||t.remove()},g=document.querySelector(".ad-form"),S=document.querySelector(".map__filters"),_=g.querySelectorAll("fieldset"),h=S.querySelectorAll("fieldset"),q=S.querySelectorAll("select"),x=document.querySelector("#housing-type"),b=document.querySelector("#housing-price"),E=document.querySelector("#housing-rooms"),w=document.querySelector("#housing-guests"),k=e=>{const t=x.value,r=b.value,o=E.value,n=w.value;return("any"===(a=t)||a===e.offer.type)&&((e,t)=>e.offer.price<=m[t.toUpperCase()].maxprice&&e.offer.price>=m[t.toUpperCase()].minprice)(e,r)&&((e,t)=>"any"===t||t===String(e.offer.rooms))(e,o)&&((e,t)=>"any"===t||t===String(e.offer.guests))(e,n)&&(e=>{const t=e.offer.features,r=Array.from(document.querySelectorAll('input[name="features"]:checked'),(e=>e.value));return 0===r.length||!!t&&r.every((e=>t.includes(e)))})(e);var a},C=[],T=document.querySelector("#address"),U=document.querySelector(".map__filters"),$=L.icon({iconUrl:"./img/main-pin.svg",iconSize:[52,52],iconAnchor:[26,52]}),A=L.icon({iconUrl:"./img/pin.svg",iconSize:[40,40],iconAnchor:[20,40]}),j=(e,t)=>{let{lat:r,lng:o}=e;return r=Number(r.toFixed(t)),o=Number(o.toFixed(t)),`${r}, ${o}`},N=L.map("map-canvas").on("load",(()=>{g.classList.toggle("ad-form--disabled",false),_.forEach((e=>{e.disabled=false}))})).setView(p,13);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(N);const D=L.marker(p,{draggable:!0,icon:$});D.addTo(N),T.value=j(D.getLatLng(),5),D.on("moveend",(e=>{T.value=j(e.target.getLatLng(),5)}));const O=L.layerGroup().addTo(N),z=t=>{L.marker({lat:t.location.lat,lng:t.location.lng},{icon:A}).addTo(O).bindPopup((({offer:t,author:r})=>{const o=f.cloneNode(!0),n=o.querySelector(".popup__title"),a=o.querySelector(".popup__text--address"),c=o.querySelector(".popup__text--price"),l=o.querySelector(".popup__type"),s=o.querySelector(".popup__text--capacity"),i=o.querySelector(".popup__text--time"),d=o.querySelector(".popup__description"),p=o.querySelector(".popup__avatar"),m=o.querySelector(".popup__features"),y=o.querySelectorAll(".popup__feature"),g=o.querySelector(".popup__photos");var S,_,h,q;return n.textContent=t.title,a.textContent=t.address,c.textContent=`${t.price} ₽/ночь`,l.textContent=u[t.type],s.textContent=`${t.rooms} ${e(t.rooms,"комната","комнаты","комнат")} для ${t.guests} ${e(t.guests,"гостя","гостей","гостей")}`,i.textContent=`Заезд после ${t.checkin}, выезд до ${t.checkout}`,d.textContent=t.description,p.src=r.avatar,v(t.title,n),v(t.address,a),v(t.price,c),v(t.type,l),v(t.rooms,s),v(t.checkin,i),v(t.description,d),v(r.avatar,p),t.features?(S=y,_=t.features,S.forEach((e=>{_.some((t=>e.classList.contains(`popup__feature--${t}`)))||e.remove()}))):m.remove(),t.photos?(h=t.photos,q=g,h.forEach((e=>{const t=q.children[0].cloneNode(!0);t.src=e,q.append(t)})),q.children[0].remove()):g.remove(),o})(t))};(async()=>{const e=await(async e=>{let o;try{o=await fetch("./data/data.json",{method:"GET",credentials:"same-origin"})}catch(e){return t(`${r}`),[]}return await o.json()})();C.push(...e),C.slice(0,10).forEach((e=>{var t;z(e),t=!1,S.classList.toggle("map__filters--disabled",t),q.forEach((e=>{e.disabled=t})),h.forEach((e=>{e.disabled=t}))}))})();const F=()=>{O.clearLayers();const e=C.filter((e=>k(e)));e.slice(0,10).forEach((e=>{z(e)})),e.length<=0&&t("Не удалось найти подходящие объявления")};U.addEventListener("change",((e,t=500)=>{let r;return(...o)=>{clearTimeout(r),r=setTimeout((()=>e.apply(void 0,o)),t)}})(F,500));const I=document.querySelector(".ad-form"),M=document.querySelector("#price"),P=document.querySelector("#type"),H=document.querySelector("#room_number"),R=document.querySelector("#capacity"),V=document.querySelector("#timein"),G=document.querySelector("#timeout"),W=document.querySelector(".ad-form__element--time"),X=window.Pristine(I,{classTo:"ad-form__element",errorClass:"ad-form__item--invalid",successClass:"ad-form__item--valid",errorTextParent:"ad-form__element",errorTextTag:"span",errorTextClass:"ad-form__error"});X.addValidator(M,(e=>e>=d[P.value]&&e<=n),(()=>`Минимальная цена за ночь: ${d[P.value]}`)),P.addEventListener("change",(()=>{M.min=d[P.value],M.placeholder=d[P.value],M.value&&X.validate(M)})),X.addValidator(R,(()=>y[H.value].includes(R.value)),(()=>"Выберите другое кол-во гостей :)")),H.addEventListener("change",(()=>{X.validate(R)})),W.addEventListener("change",(e=>{V.value=G.value=e.target.value}));const Y=document.querySelector(".ad-form__slider"),B=document.querySelector("#type");noUiSlider.create(Y,{range:{min:d[B.value],max:n},start:M.placeholder,step:100,format:{to:function(e){return Number.isInteger(e),e.toFixed(0)},from:function(e){return parseFloat(e)}}}),Y.noUiSlider.on("slide",(()=>{M.value=Y.noUiSlider.get(),X.validate(M)})),B.addEventListener("change",(()=>{Y.noUiSlider.updateOptions({range:{min:d[B.value],max:n},start:d[B.value]})}));const J=document.querySelector("body"),K=(e,t)=>{const r=e.cloneNode(!0),o=document.querySelector(".ad-form__submit");J.appendChild(r);const n=e=>{(e=>"Escape"===e.key)(e)&&(e.preventDefault(),r.remove(),J.removeEventListener("keydown",n),o.disabled=!1)};if(J.addEventListener("keydown",n),r.tabIndex=1,r.focus(),r.addEventListener("click",(()=>{r.remove(),J.removeEventListener("keydown",n),o.disabled=!1})),t){const e=r.querySelector('[type="button"]');e.focus(),e.addEventListener("click",(()=>{r.remove(),J.removeEventListener("keydown",n),o.disabled=!1}))}},Q=document.querySelector(".ad-form"),Z=document.querySelector("#address"),ee=document.querySelector(".ad-form__reset"),te=document.querySelector(".ad-form__submit"),re=document.querySelector(".map__filters"),oe=document.querySelector("#success").content.querySelector(".success"),ne=document.querySelector("#error").content.querySelector(".error"),ae=document.querySelector(".ad-form__field input[type=file]"),ce=document.querySelector(".ad-form-header__preview img"),le=document.querySelector(".ad-form__upload input[type=file]"),se=document.querySelector(".ad-form__photo"),ie=e=>{e.preventDefault(),X.reset(),Q.reset(),re.reset(),F(),ce.src="img/muffin-grey.svg",se.innerHTML="",Z.value=j(p,5),D.setLatLng(p),N.setView(p,13),N.closePopup(),Y.noUiSlider.reset()};ee.addEventListener("click",(e=>{ie(e)})),Q.addEventListener("submit",(e=>{var t,r,o,n;e.preventDefault(),X.validate()&&(t=new FormData(e.target),r=()=>ie(e),o=()=>K(oe,!1),n=()=>K(ne,!0),fetch("https://25.javascript.pages.academy/keksobooking",{method:"POST",body:t}).then((e=>{e.ok?(o(),r()):n()})).catch((()=>{n()})),te.disabled=!0)})),ae.addEventListener("change",(()=>{const[e]=ae.files,t=e.name.toLowerCase();o.some((e=>t.endsWith(e)))&&(ce.src=URL.createObjectURL(e))})),le.addEventListener("change",(()=>{const[e]=le.files,t=e.name.toLowerCase();o.some((e=>t.endsWith(e)))&&(se.innerHTML=`<img src="${URL.createObjectURL(e)}" width="70" height="70">`)}))})();